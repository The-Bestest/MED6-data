---
title: "Analysis"
output: html_notebook
---

```{r Load packages, include=FALSE}
library(tidyverse)
library(tidymodels)
library(lubridate)  # for handling dates and time
```
```{r Define functions, include=FALSE}
load_bci_data <- function(fileNamePattern) {
  # list all files in data folder, that end with "Game.csv"
  list.files(recursive=TRUE, path = "./data", pattern = fileNamePattern, full.names = T) %>%
    tibble(filename = .) %>%
    # load the contents of each CSV file
    mutate(file_contents = map(filename, ~read_csv(file.path(.),na = "NULL"))) %>%
    # extract the nested columns into a flat table
    unnest(cols=-filename) %>%
    # extract the participant label and the condition ("Level") from the file path
    separate(col=filename,sep="/",into=c("start","folder","Participant","Level","filename")) %>%
    # remove the leading "P" from participant label, e.g. P10 -> 10
    mutate(
      Participant=as.numeric(str_replace(Participant,"P","")), Level=as.factor(Level),
    ) %>%
    dplyr::group_by(Participant, Level) %>%
    mutate(
      vis_t_time = as.POSIXlt(Timestamp, format = "%Y-%m-%d %H:%M:%OS"),
      Timestamp = seconds(vis_t_time)) %>%
    ungroup()
}
```

## BCI - Continuous and Discrete Input

```{r Load pre-experiment questionnaire data, echo=FALSE, results='hide'}

```

```{r Load game data, echo=FALSE, results='hide'}
game <- load_bci_data("*Game.csv")
game <- game %>%
  # convert time to a proper Timestamp object
  dplyr::group_by(Participant, Level) %>%
  mutate(
    GameIsOn = ifelse(Event == "GameRunning", 1, 0),
    GameIsOn = cumsum(GameIsOn)) %>%
    arrange(Participant,Level,Timestamp) %>%
    dplyr::mutate(InputWindowNum = dplyr::lag(ifelse(Event == "GameDecision", 1, 0),default=0)) %>%
    dplyr::mutate(InputWindowNum = cumsum(InputWindowNum)) %>%
    ungroup()
game <- game %>%
  select(Participant, Level, InputWindowNum,Timestamp) %>%
  dplyr::group_by(Participant, Level, InputWindowNum) %>%
  dplyr::summarise(StartTime = min(Timestamp)) %>%
  right_join(game) %>%
  mutate(TimeSinceIWstart = ifelse(TrialResult == "AccInput",Timestamp - StartTime,NA))

# Filter game columns, add columns here on need-only basis
game <- game[c("Participant", "Level", "Timestamp", "GameIsOn", "InputWindowNum", "BCIConfidence")]
```

```{r Load meta data, echo=FALSE, results='hide'}
meta <- load_bci_data("*Meta.csv")

# Filter meta columns, add columns here on need-only basis
meta <- meta[c("Participant", "Level", "Timestamp")]
```

```{r Load sample data, echo=FALSE, results='hide'}
sample <- load_bci_data("*Sample.csv")

# Filter meta columns, add columns here on need-only basis
sample <- sample[c("Participant", "Level", "Event", "Timestamp", "BCIConfidence")]
```
